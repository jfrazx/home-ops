---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &app mealie-secret
  namespace: household
spec:
  refreshInterval: 5m
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao-cluster-secretstore
  target:
    name: *app
    creationPolicy: Owner
    deletionPolicy: Delete
    template:
      engineVersion: v2
      data:
        DB_ENGINE: "postgres"

        # Base Values
        ALLOW_SIGNUP: "false"
        ALLOW_PASSWORD_LOGIN: "false"
        AUTO_BACKUP_ENABLED: "true"
        WORKERS_PER_CORE: "1"
        MAX_WORKERS: "1"
        WEB_CONCURRENCY: "1"

        # OIDC
        OIDC_AUTH_ENABLED: "true"
        OIDC_ADMIN_GROUP: 'admin'
        OIDC_CLIENT_ID: "{{ .oidc_client_id}}"
        OIDC_CLIENT_SECRET: "{{ .oidc_client_secret}}"
        OIDC_PROVIDER_NAME: "Authentik"
        OIDC_CONFIGURATION_URL: "https://auth.${SECRET_DOMAIN}/application/o/mealie/.well-known/openid-configuration"

        # Ollama
        OPENAI_BASE_URL: http://ollama.ai.svc.cluster.local:11434/v1
        OPENAI_API_KEY: "mealie-this-is-not-used"
        OPENAI_MODEL: "gemma3"

        # Email
        SMTP_HOST: smtp://smtp-relay.network.svc.cluster.local:25
        SMTP_FROM_EMAIL: "{{ .smtp_username}}"
        SMTP_USER: "{{ .smtp_username}}"
        SMTP_PASSWORD: "mealie-this-is-not-used"

  data:
    - secretKey: oidc_client_id
      remoteRef:
        key: household/mealie/oidc
        property: client_id
    - secretKey: oidc_client_secret
      remoteRef:
        key: household/mealie/oidc
        property: client_secret

    - secretKey: smtp_username
      remoteRef:
        key: network/smtp-relay/gmail
        property: username
