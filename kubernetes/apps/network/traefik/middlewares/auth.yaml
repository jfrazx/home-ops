apiVersion: fluxcd.controlplane.io/v1
kind: ResourceSet
metadata:
  name: authmiddleware
  namespace: network
  annotations:
    fluxcd.controlplane.io/reconcile: "enabled"
    fluxcd.controlplane.io/reconcileEvery: "30m"
spec:
  inputs:
    - namespace: auth
    - namespace: automation
    - namespace: default
    - namespace: documents
    - namespace: external-secrets
    - namespace: kube-system
    - namespace: media
    - namespace: network
    - namespace: observability
    - namespace: storage
  resourcesTemplate: |
    ---
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: authentik-outpost
      namespace: << inputs.namespace >>
    spec:
      forwardAuth:
        address: http://ak-outpost-proxy-outpost.auth.svc.cluster.local:9000/outpost.goauthentik.io/auth/traefik
        authResponseHeaders:
          - X-authentik-username
          - X-authentik-groups
          - X-authentik-email
          - X-authentik-name
          - X-authentik-uid
          - X-authentik-jwt
          - X-authentik-meta-jwks
          - X-authentik-meta-outpost
          - X-authentik-meta-provider
          - X-authentik-meta-app
          - X-authentik-meta-version
        authResponseHeadersRegex: ""
        trustForwardHeader: true
