---
apiVersion: v1
kind: ConfigMap
metadata:
  name: smtp-relay-config
data:
  maddy.conf: |
    ## Maddy Mail Server - Relay Configuration
    state_dir /data/state
    runtime_dir /data/run

    $(hostname) = {env:SMTP_RELAY_HOSTNAME}
    $(primary_domain) = {env:SMTP_DOMAIN}

    tls file /data/tls/tls.crt /data/tls/tls.key

    ## SMTP port 25 - accepts from cluster IPs, relays everything
    smtp tcp://0.0.0.0:25 {
        deliver_to &gmail_relay
    }

    ## Submission port 587 - same behavior
    submission tcp://0.0.0.0:587 {
        deliver_to &gmail_relay
    }

    ## Gmail relay target
    target.remote gmail_relay {
        targets tls://smtp.gmail.com:587

        auth plain {env:GMAIL_USERNAME} {env:GMAIL_PASSWORD}
    }
