---
apiVersion: v1
kind: ConfigMap
metadata:
  name: smtp-relay-config
data:
  maddy.conf: |
    ## Maddy Mail Server - Relay Configuration
    state_dir /data/state
    runtime_dir /data/run

    openmetrics tcp://0.0.0.0:{env:SMTP_RELAY_METRICS_PORT} { }

    hostname {env:SMTP_RELAY_HOSTNAME}

    tls file /data/tls/tls.crt /data/tls/tls.key {
        protocols tls1.2 tls1.3
        curves X25519
    }

    ## SMTP port 25 - accepts from cluster IPs, relays everything
    smtp tcp://0.0.0.0:{env:SMTP_RELAY_SMTP_PORT} {
        default_source {
            deliver_to &gmail_relay
        }
    }

    ## Submission port 587 - same behavior
    submission tcp://0.0.0.0:{env:SMTP_RELAY_SERVER_PORT} {
        deliver_to &gmail_relay
    }

    ## Gmail relay target
    target.remote gmail_relay {
        targets tls://smtp.gmail.com:587

        auth plain {env:GMAIL_USERNAME} {env:GMAIL_PASSWORD}
    }
