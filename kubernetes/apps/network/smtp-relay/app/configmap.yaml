---
apiVersion: v1
kind: ConfigMap
metadata:
  name: smtp-relay-config
data:
  maddy.conf: |
    state_dir /data/state
    runtime_dir /data/run

    openmetrics tcp://0.0.0.0:{env:SMTP_RELAY_METRICS_PORT} { }

    hostname {env:SMTP_RELAY_HOSTNAME}

    tls file /data/tls/tls.crt /data/tls/tls.key {
        protocols tls1.2 tls1.3
        curves X25519
    }

    smtp tcp://0.0.0.0:{env:SMTP_RELAY_SMTP_PORT} {
        default_source {
            deliver_to &remote_queue
        }
    }

    target.queue remote_queue {
        target &remote_smtp
    }

    target.smtp remote_smtp {
        starttls no
        auth plain {env:GMAIL_USERNAME} {env:GMAIL_PASSWORD}
        targets tls://smtp.gmail.com:587
    }
