---
apiVersion: apps.emqx.io/v2beta1
kind: EMQX
metadata:
  name: node-red-mqtt
  namespace: automation
  labels:
    app.kubernetes.io/name: node-red-mqtt
    app.kubernetes.io/part-of: node-red-automation
spec:
  image: emqx:5.4.0

  coreTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: node-red-mqtt-core
    spec:
      replicas: 1
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 512Mi
          cpu: 200m
      volumeClaimTemplates:
        - metadata:
            name: emqx-data
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: truenas-iscsi
            resources:
              requests:
                storage: 1Gi

  config: |
    # Authentication with initial user creation
    authentication = [
      {
        backend = "built_in_database"
        mechanism = "password_based"
        password_hash_algorithm = {name = "sha256", salt_position = "suffix"}
        user_id_type = "username"
        users = [
          {
            username = "${mqtt_username}",
            password = "${mqtt_password}",
            is_superuser = true
          }
        ]
      }
    ]

    # Authorization rules
    authorization = {
      no_match = "deny"
      deny_action = "ignore"
      sources = [
        {
          type = "built_in_database"
          enable = true
        }
      ]
    }

    # Listeners
    listeners.tcp.default = {
      bind = "0.0.0.0:1883"
      max_connections = 1000
    }

    # Dashboard
    dashboard = {
      listeners.http = {
        bind = "0.0.0.0:18083"
      }
      default_username = "${admin_username}"
      default_password = "${admin_password}"
    }

    # Logging
    log = {
      console_handler = {
        level = "warning"
      }
    }
