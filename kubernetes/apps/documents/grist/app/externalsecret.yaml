---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: grist
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao-cluster-secretstore
  target:
    name: grist-secret
    creationPolicy: Owner
    deletionPolicy: Delete
    template:
      engineVersion: v2
      data:
        GRIST_OIDC_IDP_ISSUER: "{{ .oidc_issuer }}"
        GRIST_OIDC_IDP_CLIENT_ID: "{{ .oidc_client_id }}"
        GRIST_OIDC_IDP_CLIENT_SECRET: "{{ .oidc_client_secret }}"
        GRIST_OIDC_IDP_END_SESSION_ENDPOINT: "{{ .oidc_end_session_endpoint }}"
        GRIST_DEFAULT_EMAIL: "{{ .admin_email }}"
        GRIST_SESSION_SECRET: "{{ .grist_session_secret }}"
        REDIS_URL: "redis://dragonflydb.database.svc.cluster.local:6379/5?password={{ .redis_password | urlquery }}"

        GRIST_DOCS_MINIO_ACCESS_KEY: "{{ .minio_access_key }}"
        GRIST_DOCS_MINIO_SECRET_KEY: "{{ .minio_secret_key }}"
        GRIST_DOCS_MINIO_ENDPOINT: "minio.storage.svc.cluster.local"
        GRIST_DOCS_MINIO_BUCKET: "{{ .minio_bucket }}"
        GRIST_DOCS_MINIO_USE_SSL: "0"
        GRIST_DOCS_MINIO_PORT: "9000"
  data:
    - secretKey: oidc_client_id
      remoteRef:
        key: documents/grist/oidc
        property: client_id
    - secretKey: oidc_client_secret
      remoteRef:
        key: documents/grist/oidc
        property: client_secret
    - secretKey: oidc_issuer
      remoteRef:
        key: documents/grist/oidc
        property: issuer
    - secretKey: oidc_end_session_endpoint
      remoteRef:
        key: documents/grist/oidc
        property: end_session_endpoint

    - secretKey: minio_access_key
      remoteRef:
        key: documents/grist/minio
        property: access_key
    - secretKey: minio_secret_key
      remoteRef:
        key: documents/grist/minio
        property: secret_key
    - secretKey: minio_bucket
      remoteRef:
        key: documents/grist/minio
        property: bucket

    - secretKey: grist_session_secret
      remoteRef:
        key: documents/grist/config
        property: session_secret

    - secretKey: admin_email
      remoteRef:
        key: documents/grist/credentials
        property: admin_email

    - secretKey: redis_password
      remoteRef:
        key: database/dragonflydb/credentials
        property: password
