---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &name audiobookshelf
  namespace: &namespace media
spec:
  components: []
    # - ../../../../components/volsync
  targetNamespace: *namespace
  commonMetadata:
    labels:
      app.kubernetes.io/name: *name
  decryption:
    provider: sops
    secretRef:
      name: sops-age

  interval: 30m
  timeout: 5m
  path: ./kubernetes/apps/media/audiobookshelf/app
  postBuild:
    substituteFrom:
      - name: cluster-secrets
        kind: Secret
    substitute:
      APP: *name
      VOLSYNC_CAPACITY: "40Gi"
      VOLSYNC_CACHE_CAPACITY: "20Gi"
      VOLSYNC_ACCESSMODES: "ReadWriteOnce"
      VOLSYNC_SNAP_ACCESSMODES: "ReadWriteMany"
      VOLSYNC_STORAGECLASS: "truenas-iscsi"
      VOLSYNC_SNAPSHOTCLASS: "truenas-nfs-snapshots"
      VOLSYNC_REPOSITORY_NAMESPACE: "database"
      VOLSYNC_REPOSITORY_STORAGECLASS: "truenas-nfs-archive"
      VOLSYNC_REPOSITORY_SIZE: "200Gi"
      VOLSYNC_SCHEDULE: "0 4 * * *"
      VOLSYNC_PUID: "1001"
      VOLSYNC_PGID: "1001"
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
    namespace: flux-system
  wait: false
