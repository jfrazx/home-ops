---
apiVersion: pxc.percona.com/v1
kind: PerconaXtraDBCluster
metadata:
  name: &app ${APP}-mysql
  namespace: ${NAMESPACE}
  labels:
    backup/database: "true"
    kustomize.toolkit.fluxcd.io/name: *app
    kustomize.toolkit.fluxcd.io/namespace: flux-system
  annotations:
    reloader.stakater.com/auto: "true"

spec:
  crVersion: 1.16.1
  allowUnsafeConfigurations: false

  secretsName: ${APP}-mysql-secrets
  sslSecretName: ${APP}-mysql-ssl
  sslInternalSecretName: ${APP}-mysql-ssl-internal

  updateStrategy: SmartUpdate
  upgradeOptions:
    versionServiceEndpoint: https://check.percona.com
    apply: disabled
    schedule: "0 4 * * *"

  pxc:
    size: ${{MYSQL_INSTANCES}}
    image: percona/percona-xtradb-cluster:${{MYSQL_VERSION}}

    imagePullPolicy: IfNotPresent

    autoRecovery: true

    expose:
      enabled: false

    replicasServiceEnabled: true

    resources:
      requests:
        cpu: ${{MYSQL_CPU_REQUEST}}
        memory: ${{MYSQL_MEMORY_REQUEST}}
      limits:
        cpu: ${{MYSQL_CPU_LIMIT}}
        memory: ${{MYSQL_MEMORY_LIMIT}}

    affinity:
      antiAffinityTopologyKey: kubernetes.io/hostname

    podDisruptionBudget:
      maxUnavailable: 1

    volumeSpec:
      persistentVolumeClaim:
        storageClassName: ${{MYSQL_STORAGE_CLASS}}
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: ${{MYSQL_STORAGE_SIZE}}

    configuration: |
      [mysqld]
      max_connections=${{MYSQL_MAX_CONNECTIONS}}
      innodb_buffer_pool_size=${{MYSQL_INNODB_BUFFER_POOL_SIZE}}
      innodb_log_file_size=${{MYSQL_INNODB_LOG_FILE_SIZE}}
      innodb_flush_log_at_trx_commit=2
      innodb_flush_method=O_DIRECT
      innodb_file_per_table=1

      # Performance tuning
      max_allowed_packet=64M
      max_heap_table_size=32M
      tmp_table_size=32M

      # Binary logging
      binlog_expire_logs_seconds=604800
      sync_binlog=1

      # Character set
      character_set_server=utf8mb4
      collation_server=utf8mb4_unicode_ci

    # Security context - run as non-root
    containerSecurityContext:
      runAsUser: 1001
      runAsGroup: 1001
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL

    podSecurityContext:
      runAsUser: 1001
      runAsGroup: 1001
      fsGroup: 1001
      runAsNonRoot: true
      seccompProfile:
        type: RuntimeDefault

    livenessProbes:
      initialDelaySeconds: 300
      periodSeconds: 10
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 3

    readinessProbes:
      initialDelaySeconds: 15
      periodSeconds: 30
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 5

  haproxy:
    enabled: ${{MYSQL_HAPROXY_ENABLED}}
    size: ${{MYSQL_HAPROXY_INSTANCES}}
    image: percona/percona-xtradb-cluster-operator:1.16.1-haproxy

    imagePullPolicy: IfNotPresent

    resources:
      requests:
        cpu: ${{MYSQL_HAPROXY_CPU_REQUEST}}
        memory: ${{MYSQL_HAPROXY_MEMORY_REQUEST}}
      limits:
        cpu: ${{MYSQL_HAPROXY_CPU_LIMIT}}
        memory: ${{MYSQL_HAPROXY_MEMORY_LIMIT}}

    serviceType: ClusterIP

    affinity:
      antiAffinityTopologyKey: kubernetes.io/hostname

    podDisruptionBudget:
      maxUnavailable: 1

    # Security context for HAProxy
    containerSecurityContext:
      runAsUser: 1001
      runAsGroup: 1001
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL

    podSecurityContext:
      runAsUser: 1001
      runAsGroup: 1001
      fsGroup: 1001
      runAsNonRoot: true
      seccompProfile:
        type: RuntimeDefault

    livenessProbes:
      initialDelaySeconds: 60
      periodSeconds: 30
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 4

    readinessProbes:
      initialDelaySeconds: 15
      periodSeconds: 5
      timeoutSeconds: 3
      successThreshold: 1
      failureThreshold: 3

  pmm:
    enabled: false
    image: percona/pmm-client:3
    serverHost: ""

  backup:
    enabled: ${{MYSQL_BACKUP_ENABLED}}
    image: percona/percona-xtradb-cluster-operator:1.16.1-pxc8.0-backup

    imagePullPolicy: IfNotPresent

    # Security context for backups
    containerSecurityContext:
      runAsUser: 1001
      runAsGroup: 1001
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL

    schedule:
      - name: daily
        schedule: ${{MYSQL_BACKUP_SCHEDULE}}
        keep: ${{MYSQL_BACKUP_KEEP}}
        storageName: s3

    storages:
      s3:
        type: s3
        endpointUrl: ${{MYSQL_BACKUP_ENDPOINT}}
        bucket: ${{MYSQL_BACKUP_BUCKET}}
        prefix: ${{MYSQL_BACKUP_PREFIX}}
        credentialsSecret: ${APP}-mysql-backup-s3
        region: us-west-1
