---
apiVersion: pxc.percona.com/v1
kind: PerconaXtraDBCluster
metadata:
  name: &app ${APP}-mysql
  namespace: ${NAMESPACE}
  labels:
    backup/database: "true"
    kustomize.toolkit.fluxcd.io/name: *app
    kustomize.toolkit.fluxcd.io/namespace: flux-system
  annotations:
    reloader.stakater.com/auto: "true"
    kustomize.toolkit.fluxcd.io/substitute: "true"

spec:
  crVersion: 1.16.1
  allowUnsafeConfigurations: false

  secretsName: ${APP}-mysql-secrets
  sslSecretName: ${APP}-mysql-ssl-secrets
  sslInternalSecretName: ${APP}-mysql-ssl-internal

  pxc:
    size: ${MYSQL_INSTANCES:=1}
    image: percona/percona-xtradb-cluster:${MYSQL_VERSION:=8.0.44-35}

    imagePullPolicy: IfNotPresent

    resources:
      requests:
        cpu: ${MYSQL_CPU_REQUEST:=100m}
        memory: ${MYSQL_MEMORY_REQUEST:=256Mi}
      limits:
        cpu: ${MYSQL_CPU_LIMIT:=1000m}
        memory: ${MYSQL_MEMORY_LIMIT:=1Gi}

    affinity:
      antiAffinityTopologyKey: kubernetes.io/hostname

    podDisruptionBudget:
      maxUnavailable: 1

    volumeSpec:
      persistentVolumeClaim:
        storageClassName: ${MYSQL_STORAGE_CLASS:=ceph-block}
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: ${MYSQL_STORAGE_SIZE:=10Gi}

    configuration: |
      [mysqld]
      max_connections=${MYSQL_MAX_CONNECTIONS:=200}
      innodb_buffer_pool_size=${MYSQL_INNODB_BUFFER_POOL_SIZE:=256M}
      innodb_log_file_size=${MYSQL_INNODB_LOG_FILE_SIZE:=256M}
      innodb_flush_log_at_trx_commit=2
      innodb_flush_method=O_DIRECT
      innodb_file_per_table=1

      # Performance tuning
      max_allowed_packet=64M
      max_heap_table_size=32M
      tmp_table_size=32M

      # Binary logging
      binlog_expire_logs_seconds=604800
      sync_binlog=1

      # Character set
      character_set_server=utf8mb4
      collation_server=utf8mb4_unicode_ci

  haproxy:
    enabled: ${MYSQL_HAPROXY_ENABLED:=true}
    size: ${MYSQL_HAPROXY_INSTANCES:=1}
    image: percona/percona-xtradb-cluster-operator:1.18.0-haproxy

    imagePullPolicy: IfNotPresent

    resources:
      requests:
        cpu: ${MYSQL_HAPROXY_CPU_REQUEST:=50m}
        memory: ${MYSQL_HAPROXY_MEMORY_REQUEST:=64Mi}
      limits:
        cpu: ${MYSQL_HAPROXY_CPU_LIMIT:=500m}
        memory: ${MYSQL_HAPROXY_MEMORY_LIMIT:=256Mi}

    serviceType: ClusterIP

    affinity:
      antiAffinityTopologyKey: kubernetes.io/hostname

  pmm:
    enabled: ${MYSQL_MONITORING_ENABLED:=false}
    image: percona/pmm-client:2.44.1
    serverHost: ${MYSQL_PMM_SERVER:=}
    serverUser: ${MYSQL_PMM_USER:=admin}

  backup:
    enabled: ${MYSQL_BACKUP_ENABLED:=true}
    image: percona/percona-xtradb-cluster-operator:1.16.1-pxc8.0-backup

    imagePullPolicy: IfNotPresent

    schedule:
      - name: daily
        schedule: ${MYSQL_BACKUP_SCHEDULE:=0 2 * * *}
        keep: ${MYSQL_BACKUP_KEEP:=7}
        storageName: ${MYSQL_BACKUP_STORAGE:=s3}

    storages:
      s3:
        type: s3
        endpointUrl: ${MYSQL_BACKUP_ENDPOINT:=http://minio.storage.svc.cluster.local:9000}
        bucket: ${MYSQL_BACKUP_BUCKET:=mysql-backups}
        prefix: ${APP}
        credentialsSecret: ${APP}-mysql-backup-s3

        # Optional: configure storage class for backups
        # region: us-east-1
        # storageClass: STANDARD
