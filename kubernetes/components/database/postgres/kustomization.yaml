---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component
resources:
  - ./cluster.yaml
  - ./externalsecret.yaml
  - ./objectstore.yaml
  - ./scheduledbackup.yaml

configMapGenerator:
  - name: postgres-defaults
    literals:
      - POSTGRES_IMAGE_NAME="postgresql"
      - POSTGRES_VERSION="18.1"
      - POSTGRES_INSTANCES="2"
      - POSTGRES_STORAGE_SIZE="10Gi"
      - POSTGRES_ENABLE_SUPERUSER="false"
      - POSTGRES_STORAGE_CLASS="ceph-block"

      # Connection limits
      - POSTGRES_MAX_CONNECTIONS="100"
      - POSTGRES_MAX_WAL_SENDERS="5"
      - POSTGRES_MAX_REPLICATION_SLOTS="5"

      # Memory settings
      - POSTGRES_SHARED_BUFFERS="256MB"
      - POSTGRES_EFFECTIVE_CACHE_SIZE="768MB"
      - POSTGRES_MAINTENANCE_WORK_MEM="64MB"
      - POSTGRES_WORK_MEM="8MB"

      # Performance
      - POSTGRES_RANDOM_PAGE_COST="1.1"
      - POSTGRES_EFFECTIVE_IO_CONCURRENCY="200"

      # WAL
      - POSTGRES_WAL_LEVEL="replica"
      - POSTGRES_WAL_KEEP_SIZE="512MB"

      # Logging
      - POSTGRES_LOG_STATEMENT="ddl"
      - POSTGRES_LOG_MIN_DURATION_STATEMENT="5000"
      - POSTGRES_LOG_LOCK_WAITS="on"

      # Resources
      - POSTGRES_CPU_REQUEST="250m"
      - POSTGRES_MEMORY_REQUEST="1Gi"
      - POSTGRES_CPU_LIMIT="2"
      - POSTGRES_MEMORY_LIMIT="2Gi"

      # Backup
      - POSTGRES_BACKUP_SCHEDULE="0 2 * * *"
      - POSTGRES_BACKUP_RETENTION="20d"
      - POSTGRES_BACKUP_ENDPOINT="http://minio.storage.svc.cluster.local:9000"
